# AI感情分析（NLP）機能 実装完了レポート

## 📋 実装概要

**目標**: 職員の記録の質を客観的に評価し、サービス改善に活用する

福祉事業所向け請求管理システムに**AI感情分析（NLP）機能**を実装しました。この機能により、OpenAI GPT-4.1-miniを使用して職員の進捗記録を分析し、記録の質を客観的に評価できるようになりました。

---

## ✅ 実装内容

### 1. データモデルの拡張

#### **ProgressAssessmentモデルの拡張**
- **ファイル**: `billing_management/models.py`
- **追加フィールド**:
  - `record_quality_score` (IntegerField): 記録の質スコア（1〜5）
  - `ai_feedback` (TextField): AI改善提案
  - `analyzed_at` (DateTimeField): AI分析日時

#### **マイグレーション**
- マイグレーションファイル: `0007_progressassessment_ai_feedback_and_more.py`
- データベースに新しいフィールドを追加

---

### 2. バックエンド（Django）

#### **SentimentAnalysisViewビュー（AI感情分析）**
- **ファイル**: `billing_management/views.py`
- **クラス**: `SentimentAnalysisView(APIView)`
- **エンドポイント**: `/api/analyze_sentiment/<assessment_id>/`
- **メソッド**: POST
- **機能**:
  - 専門職コメントをOpenAI APIで分析
  - 感情スコア（-1.0〜1.0）を算出
  - 記録の質スコア（1〜5）を評価
  - 重要なキーワードを抽出（最大5個）
  - 具体的な改善提案を生成（100文字以内）

#### **分析項目の詳細**

| 項目 | 内容 | 範囲 | 評価基準 |
|------|------|------|---------|
| **感情スコア** | ポジティブ/ネガティブ/ニュートラル | -1.0〜1.0 | 1.0=非常にポジティブ、0.0=ニュートラル、-1.0=非常にネガティブ |
| **記録の質スコア** | 具体性、客観性、専門性 | 1〜5 | 5=最高品質、1=改善が必要 |
| **キーワード** | 重要な観察ポイント | 最大5個 | AIが自動抽出 |
| **改善提案** | 具体的なフィードバック | 100文字以内 | AIが生成 |

#### **プロンプト設計**
```python
"""
あなたは福祉事業所の専門家です。以下の職員による利用者の進捗記録を分析し、記録の質を評価してください。

【利用者情報】
- 氏名: {利用者名}
- 評価日: {評価日}
- 成長スコア: {成長スコア} / 5.0

【職員のコメント】
{専門職コメント}

以下の項目について分析し、JSON形式で回答してください：

1. sentiment_score: 感情スコア（-1.0〜1.0）
2. record_quality_score: 記録の質スコア（1〜5）
   - 具体性: 具体的な行動や状況が記録されているか
   - 客観性: 主観的な表現ではなく、客観的な観察が記録されているか
   - 専門性: 専門的な視点や用語が適切に使用されているか
3. keywords: 重要なキーワード（最大5個、カンマ区切り）
4. feedback: 改善提案（具体的なフィードバック、100文字以内）
"""
```

---

#### **AnalysisResultListViewビュー（AI分析結果一覧）**
- **ファイル**: `billing_management/views.py`
- **クラス**: `AnalysisResultListView(APIView)`
- **エンドポイント**: `/api/analysis_results/`
- **メソッド**: GET
- **機能**:
  - AI分析済みの評価データ一覧を取得
  - 最新20件を表示
  - 利用者、職員、分析結果を含む

---

#### **APIエンドポイント**
| エンドポイント | メソッド | 機能 |
|---------------|---------|------|
| `/api/analyze_sentiment/<assessment_id>/` | POST | AI感情分析を実行 |
| `/api/analysis_results/` | GET | AI分析結果一覧を取得 |

#### **URL設定**
- **ファイル**: `billing_management/urls.py`
- **追加内容**:
```python
# AI感情分析 API (強みの増強)
path('analyze_sentiment/<int:assessment_id>/', views.SentimentAnalysisView.as_view(), name='sentiment_analysis'),

# AI分析結果一覧 API
path('analysis_results/', views.AnalysisResultListView.as_view(), name='analysis_results'),
```

---

### 3. フロントエンド（React）

#### **管理者ダッシュボードへのAI分析結果表示セクション追加**
- **ファイル**: `frontend/src/Dashboard.jsx`
- **機能**:
  - AI分析結果一覧テーブルを表示
  - 記録の質スコアを色分け表示（赤・黄・緑）
  - 感情スコアをバッジ形式で表示
  - キーワードとAI改善提案を表示

#### **テーブル表示項目**
| 列 | 内容 | 表示形式 |
|----|------|---------|
| 利用者 | 氏名とコード | 山田 太郎（CLI001） |
| 評価日 | 評価実施日 | 2025/12/11 |
| 成長スコア | 利用者の成長度 | 4.8 / 5.0 |
| 感情スコア | ポジティブ/ネガティブ | +0.9（色付きバッジ） |
| 記録の質 | AI評価スコア | 5 / 5（色付きバッジ） |
| キーワード | 重要な観察ポイント | コミュニケーション, 微細運動... |
| AI改善提案 | 具体的なフィードバック | 「具体的な行動と数値が明記され...」 |
| 担当職員 | 記録作成者 | 常勤 太郎 |

#### **UI/UX設計**
✅ **色分け表示**:
  - **記録の質**: 赤（1-2）、黄（3）、緑（4-5）
  - **感情スコア**: 緑（ポジティブ）、赤（ネガティブ）

✅ **視覚的な強調**:
  - バッジ形式で重要な指標を強調
  - 色によって直感的に品質を判断可能

✅ **詳細情報**:
  - キーワードとAI改善提案を表示
  - 職員ごとの記録品質を比較可能

---

### 4. OpenAI API連携

#### **使用モデル**
- **モデル**: GPT-4.1-mini
- **理由**: 高速かつコスト効率が良く、日本語に対応

#### **API設定**
- **環境変数**: `OPENAI_API_KEY`（自動設定済み）
- **ライブラリ**: `openai==2.9.0`
- **レスポンス形式**: JSON Object

#### **プロンプトエンジニアリング**
- 福祉事業所の専門家としてのロール設定
- 具体的な評価基準を明示
- JSON形式での構造化された出力

---

## 🧪 動作確認結果

### **テスト環境**
- **バックエンド**: Django 5.2.9（ポート8000）
- **データベース**: SQLite（開発環境）
- **AIモデル**: OpenAI GPT-4.1-mini
- **テストデータ**: 2件の評価データ

### **テスト結果**

#### **ケース1: 簡潔なコメント**
- **入力コメント**: 「順調に成長しています。」
- **感情スコア**: 0.7（ポジティブ）
- **記録の質スコア**: 2 / 5（改善の余地あり）
- **キーワード**: 成長, 順調, 利用者, 進捗, 評価
- **改善提案**: 「具体的な行動や状況の記述が不足しています。観察内容や具体例を加え、客観性と専門性を高めてください。」

#### **ケース2: 詳細なコメント**
- **入力コメント**: 
```
本日の活動では、集団活動において他の利用者と積極的にコミュニケーションを取る姿が見られました。
具体的には、朝の会で自分から挨拶をし、活動中に「一緒にやろう」と声をかける場面が3回ありました。
また、制作活動では、はさみを使って紙を切る動作が以前より正確になり、直線を切ることができるようになりました。
PT（理学療法士）による個別訓練では、バランスボールを使った訓練に集中して取り組み、5分間継続することができました。
今後も、社会性の向上と微細運動能力の発達を目指して支援を継続します。
```
- **感情スコア**: 0.9（非常にポジティブ）
- **記録の質スコア**: 5 / 5（最高評価！）
- **キーワード**: コミュニケーション, 微細運動, バランスボール, 集団活動, 個別訓練
- **改善提案**: 「具体的な行動と数値が明記され、専門用語も適切です。今後は利用者の感情や反応も加えるとより深い理解につながります。」

### **AIが評価した優れた記録の特徴**
✅ **具体的な行動**: 「挨拶をし」「声をかける場面が3回」  
✅ **数値データ**: 「3回」「5分間」  
✅ **専門用語**: 「PT（理学療法士）」「微細運動能力」  
✅ **客観的な観察**: 「直線を切ることができるようになりました」

---

## 🚀 システム全体の完成度

| 機能 | 状態 | 備考 |
|------|------|------|
| 常勤換算ロジック | ✅ 実装済み | 週契約時間に基づくFTE計算 |
| 兼務専従チェック | ✅ 実装済み | 主たるサービスの勤務実績チェック |
| 管理者ダッシュボード | ✅ 実装済み | API統合、グラフ表示、アラート機能 |
| 国保連CSV出力 | ✅ 実装済み | バックエンド + フロントエンド統合 |
| 給与CSV出力 | ✅ 実装済み | 職員勤務時間の集計と出力 |
| 会計CSV出力 | ✅ 実装済み | 利用者負担額と収益の計算 |
| 個別支援計画書PDF出力 | ✅ 実装済み | 法定帳票のワンクリック出力 |
| **AI感情分析（NLP）** | **✅ 実装済み** | **記録の質を客観的に評価** |

---

## 📦 デプロイファイル

**ファイル名**: `fukushi-system-ai-complete.zip`  
**サイズ**: 約135KB  
**含まれる内容**:
- Django バックエンド（myproject/, billing_management/）
- React フロントエンド（frontend/）
- requirements.txt（Python依存関係、OpenAIを含む）
- manage.py（Django管理スクリプト）
- db.sqlite3（テストデータを含むデータベース）
- sample_support_plan.pdf（サンプルPDFファイル）

---

## 🎯 達成した効果

### **記録の質向上**

#### **Before（従来の手作業）**
- 記録の質は主観的な評価に依存
- 職員ごとの記録品質にばらつき
- 改善点が不明確
- 指導監査で記録の質を証明できない

#### **After（AI分析後）**
- 記録の質を客観的に評価（1〜5スコア）
- AIによる具体的な改善提案
- 高品質な記録の事例を共有可能
- 指導監査で記録の質を客観的に証明

### **運用効果**
- **記録品質の向上**: AIフィードバックにより、職員の記録スキルが向上
- **サービスの質向上**: 具体的で客観的な記録により、支援の質が向上
- **指導監査対応**: 記録の質を客観的に証明できる
- **職員研修**: 高品質な記録の事例を共有し、研修に活用

---

## 🔧 今後の拡張提案

### **優先度: 高**
1. **利用者離脱リスク予測**: 成長スコア、記録頻度、AI感情分析の結果を統合し、利用者がサービスを辞めるリスクを予測
   ```python
   class ChurnPredictionView(APIView):
       def get(self, request, client_id):
           # 成長スコアの推移
           # 記録頻度の変化
           # AI感情スコアの推移
           # → 離脱リスクスコア（0〜100%）を算出
   ```

2. **職員ごとの記録品質レポート**: 職員ごとの平均記録品質スコアを算出し、研修対象者を特定
   ```python
   class StaffRecordQualityReportView(APIView):
       def get(self, request):
           # 職員ごとの平均記録品質スコア
           # 改善が必要な職員のリスト
           # 高品質な記録を書く職員のリスト
   ```

3. **AI分析の自動実行**: 新しい評価データが作成されたら、自動的にAI分析を実行
   ```python
   # models.pyのProgressAssessmentモデル
   def save(self, *args, **kwargs):
       super().save(*args, **kwargs)
       if self.specialist_comment and not self.analyzed_at:
           # 非同期でAI分析を実行
           analyze_sentiment_async.delay(self.id)
   ```

### **優先度: 中**
4. **感情スコアの推移グラフ**: 利用者ごとの感情スコアの推移をグラフで表示
5. **キーワードの頻度分析**: 全体でよく使われるキーワードを分析し、トレンドを把握
6. **AI分析結果のエクスポート**: AI分析結果をCSV/PDFで出力

### **優先度: 低**
7. **多言語対応**: 英語、中国語などの記録にも対応
8. **カスタムプロンプト**: 事業所ごとにAI分析のプロンプトをカスタマイズ

---

## 📝 技術仕様

### **バックエンド**
- **フレームワーク**: Django 5.2.9
- **REST API**: Django REST Framework
- **データベース**: SQLite（開発）/ PostgreSQL（本番推奨）
- **AIモデル**: OpenAI GPT-4.1-mini
- **ライブラリ**: openai==2.9.0

### **フロントエンド**
- **フレームワーク**: React 18
- **ビルドツール**: Vite
- **HTTPクライアント**: axios
- **グラフライブラリ**: Recharts
- **スタイリング**: インラインスタイル

### **デプロイ**
- **推奨プラットフォーム**: Render
- **バージョン管理**: GitHub
- **自動デプロイ**: GitHub連携による自動デプロイ
- **環境変数**: `OPENAI_API_KEY`（本番環境で設定）

---

## 🎯 達成目標の進捗

> **「強みの増強により、圧倒的な優位性を確立する」**

### **フェーズ1: 運用負担のゼロ化**
- ✅ **1-1 国保連CSV出力**: 完了
- ✅ **1-2 会計/給与CSV出力**: 完了
- ✅ **1-3 個別支援計画書PDF出力**: 完了

### **フェーズ2: 強みの増強（AI連携）**
- ✅ **2-1 AI感情分析（NLP）**: 完了
- ⏳ **2-2 利用者離脱リスク予測**: 次のステップ

---

## 📞 サポート情報

**開発環境**: Ubuntu 22.04, Python 3.11, Node.js 22.13.0  
**作成日**: 2025年12月11日  
**バージョン**: 4.0.0

---

## 🏆 AI連携機能 実装完了

**AI感情分析（NLP）機能**の実装により、福祉事業所向け請求管理システムの**強みの増強**が完了しました。

### **実装完了した機能**
1. ✅ **請求機能**: 国保連CSV出力
2. ✅ **経理連携**: 会計/給与CSV出力
3. ✅ **指導監査対応**: 個別支援計画書PDF出力
4. ✅ **AI連携**: 記録品質の客観的評価

### **次のステップ**
**2-2 利用者離脱リスク予測**に進み、経営判断に直結する予測機能を実装します。

- **目的**: 利用者がサービスを辞めるリスクを自動で予測
- **データソース**: 成長スコア、記録頻度、AI感情分析の結果
- **出力**: 離脱リスクスコア（0〜100%）とアラート

---

**以上、AI感情分析（NLP）機能の実装完了レポートでした。**

**次のステップ**: 利用者離脱リスク予測機能の実装に進みます。
