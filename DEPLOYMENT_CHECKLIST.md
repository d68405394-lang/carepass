# 本番環境デプロイチェックリスト

## デプロイ前の確認事項

### ✅ 完了済み

- [x] CustomUserモデルの実装
- [x] locationフィールドの追加（Client, Staff, WorkRecord, ProgressAssessment）
- [x] Django管理画面のカスタマイズ
- [x] ロケーションベースのデータフィルタリング実装
- [x] パーミッションシステムの統合
- [x] サンプルデータスクリプトの更新
- [x] ローカル環境でのテスト
- [x] GitHubへのプッシュ

### ⏳ デプロイ中

- [ ] Renderでの自動デプロイ完了確認
- [ ] マイグレーションの自動実行確認

## 本番環境でのテスト手順

### 1. デプロイ状況の確認

Renderダッシュボードで以下を確認：
- ビルドステータス: Success
- デプロイステータス: Live
- ログにエラーがないこと

### 2. データベースマイグレーションの確認

Render Shellで以下のコマンドを実行：
```bash
python manage.py showmigrations
```

**期待される結果:**
```
billing_management
 [X] 0001_initial
```

### 3. サンプルデータの投入

Render Shellまたはカスタムコマンドで実行：
```bash
python load_sample_data.py
```

**期待される結果:**
- 3つの事業所が作成される
- 8名のユーザーが作成される（パーミッション付き）
- 5名の利用者が作成される

### 4. 管理画面へのアクセステスト

#### テスト4-1: スーパー管理者ログイン
1. 本番環境のURL + `/admin/` にアクセス
2. ログイン情報:
   - ユーザー名: `sample_superadmin`
   - パスワード: `admin123`
3. 確認事項:
   - ログイン成功
   - 全モデルが表示される
   - 利用者リストに5名全員が表示される

#### テスト4-2: 事業所管理者ログイン（東京）
1. ログアウト
2. ログイン情報:
   - ユーザー名: `sample_admin_tokyo`
   - パスワード: `admin123`
3. 確認事項:
   - ログイン成功
   - billing_managementモデルが表示される
   - 利用者リストに東京の2名のみ表示される
   - 大阪・名古屋の利用者は表示されない

#### テスト4-3: 事業所管理者ログイン（大阪）
1. ログアウト
2. ログイン情報:
   - ユーザー名: `sample_admin_osaka`
   - パスワード: `admin123`
3. 確認事項:
   - ログイン成功
   - 利用者リストに大阪の2名のみ表示される
   - 東京・名古屋の利用者は表示されない

#### テスト4-4: スタッフログイン（東京）
1. ログアウト
2. ログイン情報:
   - ユーザー名: `sample_staff_tokyo1`
   - パスワード: `staff123`
3. 確認事項:
   - ログイン成功
   - 利用者の閲覧・追加・変更が可能
   - 削除権限がない
   - 東京の利用者のみ表示される

### 5. データ分離のテスト

#### テスト5-1: 新規利用者の作成（事業所管理者）
1. sample_admin_tokyoでログイン
2. 新規利用者を作成
3. 確認事項:
   - 事業所フィールドが自動的に「サンプル事業所A（東京）」に設定される
   - 他の事業所を選択できない
   - 作成後、利用者リストに表示される

#### テスト5-2: URLによる直接アクセス制限
1. sample_admin_tokyoでログイン
2. 大阪の利用者のIDを確認（例: 3）
3. URLを直接入力: `/admin/billing_management/client/3/change/`
4. 確認事項:
   - アクセスが拒否される、または404エラーが表示される
   - 他の事業所のデータにアクセスできない

### 6. パーミッションのテスト

#### テスト6-1: スタッフの削除権限
1. sample_staff_tokyo1でログイン
2. 利用者の詳細ページにアクセス
3. 確認事項:
   - 「削除」ボタンが表示されない
   - 削除アクションが実行できない

#### テスト6-2: 事業所管理者の全権限
1. sample_admin_tokyoでログイン
2. 利用者の詳細ページにアクセス
3. 確認事項:
   - 閲覧、追加、変更、削除の全権限がある
   - 「削除」ボタンが表示される

## トラブルシューティング

### 問題1: マイグレーションエラー

**症状:** デプロイ後にマイグレーションエラーが発生

**解決策:**
1. Render Shellにアクセス
2. 以下のコマンドを実行:
```bash
python manage.py migrate --fake-initial
```

### 問題2: パーミッションが付与されていない

**症状:** 事業所管理者でログインしても「You don't have permission to view or edit anything.」と表示される

**解決策:**
1. Render Shellにアクセス
2. サンプルデータスクリプトを再実行:
```bash
python load_sample_data.py
```

### 問題3: 既存データとの競合

**症状:** マイグレーション実行時に既存データとの競合エラー

**解決策:**
1. 本番環境のデータベースをバックアップ
2. Render Shellで以下を実行:
```bash
python manage.py migrate billing_management zero
python manage.py migrate
```

## 本番環境での注意事項

### セキュリティ
- [ ] SECRET_KEYが環境変数で設定されている
- [ ] DEBUG=Falseに設定されている
- [ ] ALLOWED_HOSTSが正しく設定されている
- [ ] CSRF保護が有効になっている

### データベース
- [ ] データベース接続が正常
- [ ] バックアップが設定されている
- [ ] SSL接続が有効

### 監視
- [ ] Renderのログを定期的に確認
- [ ] エラー通知が設定されている
- [ ] パフォーマンスモニタリングが有効

## デプロイ完了後のアクション

### 即座に実行
- [ ] 管理画面にアクセスできることを確認
- [ ] スーパー管理者でログインできることを確認
- [ ] サンプルデータが正しく投入されていることを確認

### 24時間以内
- [ ] 全ロールでのログインテストを完了
- [ ] データ分離が正しく機能していることを確認
- [ ] パフォーマンステストを実施

### 1週間以内
- [ ] 実際のユーザーにテストアクセスを依頼
- [ ] フィードバックを収集
- [ ] 必要に応じて調整

## テスト結果記録

### スーパー管理者テスト
- 実施日時: _______________
- 結果: [ ] 成功 / [ ] 失敗
- 備考: _______________

### 事業所管理者テスト（東京）
- 実施日時: _______________
- 結果: [ ] 成功 / [ ] 失敗
- 備考: _______________

### 事業所管理者テスト（大阪）
- 実施日時: _______________
- 結果: [ ] 成功 / [ ] 失敗
- 備考: _______________

### スタッフテスト
- 実施日時: _______________
- 結果: [ ] 成功 / [ ] 失敗
- 備考: _______________

### データ分離テスト
- 実施日時: _______________
- 結果: [ ] 成功 / [ ] 失敗
- 備考: _______________

## 承認

- [ ] 開発者: _______________（日付: _______________）
- [ ] テスター: _______________（日付: _______________）
- [ ] プロジェクトマネージャー: _______________（日付: _______________）

## 次のステップ

デプロイとテストが完了したら、以下のドキュメントを参照してください：
- `MULTI_TENANT_IMPLEMENTATION.md`: 実装の詳細
- `README.md`: プロジェクト全体の概要
- `test_results.md`: ローカル環境でのテスト結果
