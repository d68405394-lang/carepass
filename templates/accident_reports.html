<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‹æ•…ãƒ»ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆå ±å‘Šæ›¸ - Care Pass</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                        sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .header-logo {
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            color: white;
        }
        
        .header-nav a {
            color: white;
            text-decoration: none;
            margin-left: 1.5rem;
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        
        .header-nav a:hover {
            opacity: 1;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .page-title h1 {
            font-size: 1.8rem;
            color: #333;
        }
        
        .page-title p {
            color: #666;
            margin-top: 0.5rem;
        }
        
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .filter-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .filter-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .filter-group label {
            font-size: 0.85rem;
            color: #666;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .report-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .report-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .report-table th,
        .report-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .report-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        .report-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-draft {
            background: #e9ecef;
            color: #495057;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .type-accident {
            background: #f8d7da;
            color: #721c24;
        }
        
        .type-hiyari {
            background: #cce5ff;
            color: #004085;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 5px;
            font-size: 0.8rem;
            text-decoration: none;
            cursor: pointer;
            border: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }
        
        .empty-state h3 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h2 {
            color: #333;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        .ai-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 1px solid #e9ecef;
        }
        
        .ai-section h3 {
            color: #667eea;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .ai-result {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #ddd;
        }
        
        .ai-result h4 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .ai-result p {
            color: #666;
            line-height: 1.6;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 1.5rem;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .history-list {
            list-style: none;
        }
        
        .history-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .history-content h4 {
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .history-content p {
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/" class="header-logo">ğŸ¥ Care Pass</a>
        <nav class="header-nav">
            <a href="/">ãƒ›ãƒ¼ãƒ </a>
            <a href="/statutory-documents/">æ³•å®šæ›¸é¡</a>
            <a href="/progress/">é€²æ—ç®¡ç†</a>
            <a href="/billing/">è«‹æ±‚ç®¡ç†</a>
        </nav>
    </div>
    
    <div class="container">
        <div class="page-header">
            <div class="page-title">
                <h1>âš ï¸ äº‹æ•…ãƒ»ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆå ±å‘Šæ›¸</h1>
                <p>äº‹æ•…ç™ºç”Ÿæ™‚ã®å ±å‘Šæ›¸ã‚’AIãŒè‡ªå‹•ç”Ÿæˆã—ã¾ã™</p>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal()">
                ï¼‹ æ–°è¦ä½œæˆ
            </button>
        </div>
        
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label>åŒºåˆ†</label>
                    <select id="filter-type">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="accident">äº‹æ•…</option>
                        <option value="hiyari_hatto">ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select id="filter-status">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="draft">ä½œæˆä¸­</option>
                        <option value="pending_review">æ‰¿èªå¾…ã¡</option>
                        <option value="approved">æ‰¿èªæ¸ˆã¿</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>æœŸé–“</label>
                    <input type="date" id="filter-date-from">
                </div>
                <div class="filter-group">
                    <label>ã€œ</label>
                    <input type="date" id="filter-date-to">
                </div>
                <button class="btn btn-secondary" onclick="applyFilters()">æ¤œç´¢</button>
            </div>
        </div>
        
        <div class="report-table">
            <table>
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>åŒºåˆ†</th>
                        <th>ç™ºç”Ÿæ—¥æ™‚</th>
                        <th>åˆ©ç”¨è€…å</th>
                        <th>å ±å‘Šè€…</th>
                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th>è¡Œæ”¿å ±å‘Š</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="report-list">
                    <!-- ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§å‹•çš„ã«æŒ¿å…¥ -->
                </tbody>
            </table>
            
            <div class="empty-state" id="empty-state" style="display: none;">
                <h3>ğŸ“‹ å ±å‘Šæ›¸ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                <p>ã€Œæ–°è¦ä½œæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰æœ€åˆã®å ±å‘Šæ›¸ã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
            </div>
        </div>
    </div>
    
    <!-- æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="create-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ æ–°è¦å ±å‘Šæ›¸ä½œæˆ</h2>
                <button class="modal-close" onclick="closeModal('create-modal')">&times;</button>
            </div>
            
            <form id="create-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>åŒºåˆ† *</label>
                        <select name="report_type" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="accident">äº‹æ•…</option>
                            <option value="hiyari_hatto">ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç™ºç”Ÿæ—¥æ™‚ *</label>
                        <input type="datetime-local" name="occurred_at" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>åˆ©ç”¨è€… *</label>
                        <select name="client" required id="client-select">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <!-- å‹•çš„ã«æŒ¿å…¥ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç™ºç”Ÿå ´æ‰€ï¼ˆäº‹æ¥­æ‰€ï¼‰ *</label>
                        <select name="location" required id="location-select">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <!-- å‹•çš„ã«æŒ¿å…¥ -->
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥ *</label>
                        <select name="service_type" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="houmon_kaigo">è¨ªå•ä»‹è­·</option>
                            <option value="houmon_kango">è¨ªå•çœ‹è­·</option>
                            <option value="day_service">é€šæ‰€ä»‹è­·ï¼ˆãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ï¼‰</option>
                            <option value="day_care">é€šæ‰€ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ã‚¤ã‚±ã‚¢ï¼‰</option>
                            <option value="short_stay">çŸ­æœŸå…¥æ‰€ç”Ÿæ´»ä»‹è­·ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼‰</option>
                            <option value="group_home">èªçŸ¥ç—‡å¯¾å¿œå‹å…±åŒç”Ÿæ´»ä»‹è­·ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ ï¼‰</option>
                            <option value="houdehi">æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹</option>
                            <option value="jihatsu">å…ç«¥ç™ºé”æ”¯æ´</option>
                            <option value="other">ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç™ºç”Ÿå ´æ‰€ï¼ˆè©³ç´°ï¼‰</label>
                        <input type="text" name="location_detail" placeholder="ä¾‹: å±…å®¤å†…ã€å»Šä¸‹ã€ãƒˆã‚¤ãƒ¬">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>äº‹å®ŸçµŒéï¼ˆä½•ãŒèµ·ããŸã‹ï¼‰*</label>
                    <textarea name="incident_description" placeholder="ç™ºç”Ÿæ™‚ã®çŠ¶æ³ã‚’æ™‚ç³»åˆ—ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚éŸ³å£°å…¥åŠ›ã‚‚å¯èƒ½ã§ã™ã€‚" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>åˆ©ç”¨è€…ã®çŠ¶æ…‹</label>
                        <textarea name="client_state" placeholder="ç™ºç”Ÿæ™‚ãƒ»ç™ºç”Ÿå¾Œã®åˆ©ç”¨è€…ã®çŠ¶æ…‹"></textarea>
                    </div>
                    <div class="form-group">
                        <label>è¢«å®³ã®çŠ¶æ³</label>
                        <textarea name="damage_status" placeholder="æ€ªæˆ‘ã®æœ‰ç„¡ã€ç¨‹åº¦ã€éƒ¨ä½ãªã©"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>åˆæœŸå¯¾å¿œ</label>
                    <textarea name="initial_response" placeholder="ç™ºç”Ÿç›´å¾Œã«è¡Œã£ãŸå¯¾å¿œ"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>å®¶æ—ã¸ã®é€£çµ¡çŠ¶æ³</label>
                        <textarea name="family_contact_log" placeholder="é€£çµ¡æ—¥æ™‚ã€é€£çµ¡å…ˆã€é€£çµ¡å†…å®¹"></textarea>
                    </div>
                    <div class="form-group">
                        <label>åŒ»ç™‚æ©Ÿé–¢ã¸ã®å¯¾å¿œ</label>
                        <textarea name="medical_response" placeholder="å—è¨ºã®æœ‰ç„¡ã€åŒ»ç™‚æ©Ÿé–¢åã€è¨ºæ–­å†…å®¹"></textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('create-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜ã—ã¦æ¬¡ã¸</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ å ±å‘Šæ›¸è©³ç´°</h2>
                <button class="modal-close" onclick="closeModal('detail-modal')">&times;</button>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="basic">åŸºæœ¬æƒ…å ±</div>
                <div class="tab" data-tab="ai">AIç”Ÿæˆ</div>
                <div class="tab" data-tab="history">å±¥æ­´</div>
            </div>
            
            <div class="tab-content active" id="tab-basic">
                <div id="detail-content">
                    <!-- å‹•çš„ã«æŒ¿å…¥ -->
                </div>
            </div>
            
            <div class="tab-content" id="tab-ai">
                <div class="ai-section">
                    <h3>ğŸ¤– AIè‡ªå‹•ç”Ÿæˆ</h3>
                    <p>å…¥åŠ›ã•ã‚ŒãŸäº‹å®Ÿæƒ…å ±ã‚’åŸºã«ã€AIãŒå ±å‘Šæ›¸ã®å„é …ç›®ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚</p>
                    <button class="btn btn-primary" id="generate-ai-btn" onclick="generateAI()">
                        AIç”Ÿæˆã‚’å®Ÿè¡Œ
                    </button>
                    
                    <div class="loading" id="ai-loading">
                        <div class="spinner"></div>
                        <p>AIãŒå ±å‘Šæ›¸ã‚’ç”Ÿæˆä¸­...</p>
                    </div>
                    
                    <div id="ai-results">
                        <!-- AIç”ŸæˆçµæœãŒæŒ¿å…¥ã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="tab-history">
                <h3>ğŸ“œ å¤‰æ›´å±¥æ­´</h3>
                <ul class="history-list" id="history-list">
                    <!-- å‹•çš„ã«æŒ¿å…¥ -->
                </ul>
            </div>
            
            <div class="form-actions" id="detail-actions">
                <!-- å‹•çš„ã«æŒ¿å…¥ -->
            </div>
        </div>
    </div>
    
    <script>
        let currentReportId = null;
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        document.addEventListener('DOMContentLoaded', function() {
            loadReports();
            loadClients();
            loadLocations();
            setupTabs();
        });
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('tab-' + tabId).classList.add('active');
                });
            });
        }
        
        // å ±å‘Šæ›¸ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadReports() {
            try {
                const response = await fetch('/api/accident-reports/');
                if (response.ok) {
                    const reports = await response.json();
                    renderReports(reports);
                } else {
                    console.error('Failed to load reports');
                }
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }
        
        // å ±å‘Šæ›¸ä¸€è¦§ã‚’æç”»
        function renderReports(reports) {
            const tbody = document.getElementById('report-list');
            const emptyState = document.getElementById('empty-state');
            
            if (reports.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tbody.innerHTML = reports.map((report, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        <span class="type-badge type-${report.report_type === 'accident' ? 'accident' : 'hiyari'}">
                            ${report.report_type_display}
                        </span>
                    </td>
                    <td>${formatDateTime(report.occurred_at)}</td>
                    <td>${report.client_name}</td>
                    <td>${report.reporter_name}</td>
                    <td>
                        <span class="status-badge status-${report.status}">
                            ${report.status_display}
                        </span>
                    </td>
                    <td>${report.is_government_report_needed ? 'âš ï¸ è¦' : 'ï¼'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-primary" onclick="openDetailModal(${report.id})">è©³ç´°</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // åˆ©ç”¨è€…ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadClients() {
            try {
                const response = await fetch('/api/clients/');
                if (response.ok) {
                    const clients = await response.json();
                    const select = document.getElementById('client-select');
                    clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.full_name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }
        
        // äº‹æ¥­æ‰€ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadLocations() {
            try {
                const response = await fetch('/api/service-locations/');
                if (response.ok) {
                    const locations = await response.json();
                    const select = document.getElementById('location-select');
                    locations.forEach(location => {
                        const option = document.createElement('option');
                        option.value = location.id;
                        option.textContent = location.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }
        
        // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openCreateModal() {
            document.getElementById('create-modal').classList.add('active');
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        async function openDetailModal(reportId) {
            currentReportId = reportId;
            
            try {
                const response = await fetch(`/api/accident-reports/${reportId}/`);
                if (response.ok) {
                    const report = await response.json();
                    renderDetailContent(report);
                    loadHistory(reportId);
                    document.getElementById('detail-modal').classList.add('active');
                }
            } catch (error) {
                console.error('Error loading report detail:', error);
            }
        }
        
        // è©³ç´°å†…å®¹ã‚’æç”»
        function renderDetailContent(report) {
            const content = document.getElementById('detail-content');
            content.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>åŒºåˆ†</label>
                        <p>${report.report_type_display}</p>
                    </div>
                    <div class="form-group">
                        <label>ç™ºç”Ÿæ—¥æ™‚</label>
                        <p>${formatDateTime(report.occurred_at)}</p>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>åˆ©ç”¨è€…</label>
                        <p>${report.client_name}</p>
                    </div>
                    <div class="form-group">
                        <label>ç™ºç”Ÿå ´æ‰€</label>
                        <p>${report.location_name} - ${report.location_detail || ''}</p>
                    </div>
                </div>
                <div class="form-group">
                    <label>äº‹å®ŸçµŒé</label>
                    <p>${report.incident_description || 'ï¼ˆè¨˜è¼‰ãªã—ï¼‰'}</p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>åˆ©ç”¨è€…ã®çŠ¶æ…‹</label>
                        <p>${report.client_state || 'ï¼ˆè¨˜è¼‰ãªã—ï¼‰'}</p>
                    </div>
                    <div class="form-group">
                        <label>è¢«å®³ã®çŠ¶æ³</label>
                        <p>${report.damage_status || 'ï¼ˆè¨˜è¼‰ãªã—ï¼‰'}</p>
                    </div>
                </div>
                <div class="form-group">
                    <label>åˆæœŸå¯¾å¿œ</label>
                    <p>${report.initial_response || 'ï¼ˆè¨˜è¼‰ãªã—ï¼‰'}</p>
                </div>
            `;
            
            // AIç”Ÿæˆçµæœã‚’è¡¨ç¤º
            const aiResults = document.getElementById('ai-results');
            if (report.ai_generated_overview) {
                aiResults.innerHTML = `
                    <div class="ai-result">
                        <h4>ğŸ“ äº‹æ•…ã®çŠ¶æ³ï¼ˆAIç”Ÿæˆï¼‰</h4>
                        <p>${report.ai_generated_overview}</p>
                    </div>
                    <div class="ai-result">
                        <h4>ğŸ” åŸå› åˆ†æï¼ˆAIç”Ÿæˆï¼‰</h4>
                        <p>${report.ai_generated_cause_analysis}</p>
                    </div>
                    <div class="ai-result">
                        <h4>ğŸ›¡ï¸ å†ç™ºé˜²æ­¢ç­–ï¼ˆAIç”Ÿæˆï¼‰</h4>
                        <p>${report.ai_generated_prevention_plan}</p>
                    </div>
                    <div class="ai-result">
                        <h4>ğŸ“‹ è¡Œæ”¿å ±å‘Šè¦å¦</h4>
                        <p><strong>${report.is_government_report_needed ? 'âš ï¸ å ±å‘ŠãŒå¿…è¦' : 'å ±å‘Šä¸è¦'}</strong></p>
                        <p>${report.government_report_reason}</p>
                    </div>
                `;
            } else {
                aiResults.innerHTML = '<p>AIç”Ÿæˆã¯ã¾ã å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€ŒAIç”Ÿæˆã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>';
            }
            
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
            const actions = document.getElementById('detail-actions');
            let buttons = '';
            
            if (report.status === 'draft') {
                buttons += `<button class="btn btn-primary" onclick="generateAI()">AIç”Ÿæˆ</button>`;
                buttons += `<button class="btn btn-success" onclick="submitForReview()">æ‰¿èªç”³è«‹</button>`;
            } else if (report.status === 'pending_review') {
                buttons += `<button class="btn btn-success" onclick="approveReport()">æ‰¿èª</button>`;
                buttons += `<button class="btn btn-warning" onclick="rejectReport()">å·®æˆ»ã—</button>`;
            }
            
            buttons += `<button class="btn btn-secondary" onclick="downloadPDF()">PDFå‡ºåŠ›</button>`;
            buttons += `<button class="btn btn-secondary" onclick="closeModal('detail-modal')">é–‰ã˜ã‚‹</button>`;
            
            actions.innerHTML = buttons;
        }
        
        // å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        async function loadHistory(reportId) {
            try {
                const response = await fetch(`/api/accident-reports/${reportId}/audit_trails/`);
                if (response.ok) {
                    const trails = await response.json();
                    const list = document.getElementById('history-list');
                    list.innerHTML = trails.map(trail => `
                        <li class="history-item">
                            <div class="history-icon">ğŸ“</div>
                            <div class="history-content">
                                <h4>${trail.action_display}</h4>
                                <p>${trail.user_name} - ${formatDateTime(trail.timestamp)}</p>
                            </div>
                        </li>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }
        
        // AIç”Ÿæˆã‚’å®Ÿè¡Œ
        async function generateAI() {
            if (!currentReportId) return;
            
            document.getElementById('ai-loading').classList.add('active');
            document.getElementById('generate-ai-btn').disabled = true;
            
            try {
                const response = await fetch(`/api/accident-reports/${currentReportId}/generate_ai/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const report = await response.json();
                    renderDetailContent(report);
                    alert('AIç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
                } else {
                    alert('AIç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error generating AI:', error);
                alert('AIç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                document.getElementById('ai-loading').classList.remove('active');
                document.getElementById('generate-ai-btn').disabled = false;
            }
        }
        
        // æ‰¿èªç”³è«‹
        async function submitForReview() {
            if (!currentReportId) return;
            
            try {
                const response = await fetch(`/api/accident-reports/${currentReportId}/submit_for_review/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    alert('æ‰¿èªç”³è«‹ã—ã¾ã—ãŸ');
                    closeModal('detail-modal');
                    loadReports();
                } else {
                    alert('æ‰¿èªç”³è«‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error submitting for review:', error);
            }
        }
        
        // æ‰¿èª
        async function approveReport() {
            if (!currentReportId) return;
            
            try {
                const response = await fetch(`/api/accident-reports/${currentReportId}/approve/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    alert('æ‰¿èªã—ã¾ã—ãŸ');
                    closeModal('detail-modal');
                    loadReports();
                } else {
                    alert('æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error approving:', error);
            }
        }
        
        // å·®æˆ»ã—
        async function rejectReport() {
            if (!currentReportId) return;
            
            const reason = prompt('å·®æˆ»ã—ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/accident-reports/${currentReportId}/reject/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reason })
                });
                
                if (response.ok) {
                    alert('å·®æˆ»ã—ã—ã¾ã—ãŸ');
                    closeModal('detail-modal');
                    loadReports();
                } else {
                    alert('å·®æˆ»ã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error rejecting:', error);
            }
        }
        
        // PDFå‡ºåŠ›
        function downloadPDF() {
            if (!currentReportId) return;
            window.open(`/api/accident-reports/${currentReportId}/pdf/`, '_blank');
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function applyFilters() {
            // TODO: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã®å®Ÿè£…
            loadReports();
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('create-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/accident-reports/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const report = await response.json();
                    alert('å ±å‘Šæ›¸ã‚’ä½œæˆã—ã¾ã—ãŸ');
                    closeModal('create-modal');
                    this.reset();
                    loadReports();
                    openDetailModal(report.id);
                } else {
                    const error = await response.json();
                    alert('ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + JSON.stringify(error));
                }
            } catch (error) {
                console.error('Error creating report:', error);
                alert('ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        });
    </script>
</body>
</html>
